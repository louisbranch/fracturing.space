services:
  init-data:
    image: busybox:1.36
    command: ["sh", "-c", "chown -R 65532:65532 /data"]
    volumes:
      - fracturing-space-data:/data

  game:
    build:
      context: .
      target: game
      args:
        GO_VERSION: ${GO_VERSION:-1.25.6}
    image: docker.io/louisbranch/fracturing.space-game:dev
    depends_on:
      init-data:
        condition: service_completed_successfully
    environment:
      - FRACTURING_SPACE_GAME_DB_PATH=/data/game.db
    volumes:
      - fracturing-space-data:/data
    ports:
      - "127.0.0.1:8080:8080"

  mcp:
    build:
      context: .
      target: mcp
      args:
        GO_VERSION: ${GO_VERSION:-1.25.6}
    image: docker.io/louisbranch/fracturing.space-mcp:dev
    command: ["-transport=http", "-http-addr=0.0.0.0:8081", "-addr=game:8080"]
    depends_on:
      - game
    ports:
      - "127.0.0.1:8081:8081"

  admin:
    build:
      context: .
      target: admin
      args:
        GO_VERSION: ${GO_VERSION:-1.25.6}
    image: docker.io/louisbranch/fracturing.space-admin:dev
    depends_on:
      - game
    environment:
      - FRACTURING_SPACE_ADMIN_ADDR=0.0.0.0:8082
      - FRACTURING_SPACE_GAME_ADDR=game:8080
    ports:
      - "127.0.0.1:8082:8082"

volumes:
  fracturing-space-data:
