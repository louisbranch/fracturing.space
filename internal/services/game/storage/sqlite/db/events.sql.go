// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.30.0
// source: events.sql

package db

import (
	"context"
	"database/sql"
)

const appendEvent = `-- name: AppendEvent :exec

INSERT INTO events (
    campaign_id, seq, event_hash, timestamp, event_type,
    session_id, request_id, invocation_id,
    actor_type, actor_id, entity_type, entity_id, payload_json
) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
`

type AppendEventParams struct {
	CampaignID   string `json:"campaign_id"`
	Seq          int64  `json:"seq"`
	EventHash    string `json:"event_hash"`
	Timestamp    int64  `json:"timestamp"`
	EventType    string `json:"event_type"`
	SessionID    string `json:"session_id"`
	RequestID    string `json:"request_id"`
	InvocationID string `json:"invocation_id"`
	ActorType    string `json:"actor_type"`
	ActorID      string `json:"actor_id"`
	EntityType   string `json:"entity_type"`
	EntityID     string `json:"entity_id"`
	PayloadJson  []byte `json:"payload_json"`
}

// Unified Events Table Queries
func (q *Queries) AppendEvent(ctx context.Context, arg AppendEventParams) error {
	_, err := q.db.ExecContext(ctx, appendEvent,
		arg.CampaignID,
		arg.Seq,
		arg.EventHash,
		arg.Timestamp,
		arg.EventType,
		arg.SessionID,
		arg.RequestID,
		arg.InvocationID,
		arg.ActorType,
		arg.ActorID,
		arg.EntityType,
		arg.EntityID,
		arg.PayloadJson,
	)
	return err
}

const checkOutcomeApplied = `-- name: CheckOutcomeApplied :one

SELECT EXISTS(SELECT 1 FROM outcome_applied WHERE campaign_id = ? AND session_id = ? AND request_id = ?) as applied
`

type CheckOutcomeAppliedParams struct {
	CampaignID string `json:"campaign_id"`
	SessionID  string `json:"session_id"`
	RequestID  string `json:"request_id"`
}

// Outcome Applied Tracking
func (q *Queries) CheckOutcomeApplied(ctx context.Context, arg CheckOutcomeAppliedParams) (int64, error) {
	row := q.db.QueryRowContext(ctx, checkOutcomeApplied, arg.CampaignID, arg.SessionID, arg.RequestID)
	var applied int64
	err := row.Scan(&applied)
	return applied, err
}

const getCampaignForkMetadata = `-- name: GetCampaignForkMetadata :one

SELECT parent_campaign_id, fork_event_seq, origin_campaign_id
FROM campaigns
WHERE id = ?
`

type GetCampaignForkMetadataRow struct {
	ParentCampaignID sql.NullString `json:"parent_campaign_id"`
	ForkEventSeq     sql.NullInt64  `json:"fork_event_seq"`
	OriginCampaignID sql.NullString `json:"origin_campaign_id"`
}

// Fork Metadata Queries
func (q *Queries) GetCampaignForkMetadata(ctx context.Context, id string) (GetCampaignForkMetadataRow, error) {
	row := q.db.QueryRowContext(ctx, getCampaignForkMetadata, id)
	var i GetCampaignForkMetadataRow
	err := row.Scan(&i.ParentCampaignID, &i.ForkEventSeq, &i.OriginCampaignID)
	return i, err
}

const getEventByHash = `-- name: GetEventByHash :one
SELECT campaign_id, seq, event_hash, timestamp, event_type, session_id, request_id, invocation_id, actor_type, actor_id, entity_type, entity_id, payload_json FROM events WHERE event_hash = ?
`

func (q *Queries) GetEventByHash(ctx context.Context, eventHash string) (Event, error) {
	row := q.db.QueryRowContext(ctx, getEventByHash, eventHash)
	var i Event
	err := row.Scan(
		&i.CampaignID,
		&i.Seq,
		&i.EventHash,
		&i.Timestamp,
		&i.EventType,
		&i.SessionID,
		&i.RequestID,
		&i.InvocationID,
		&i.ActorType,
		&i.ActorID,
		&i.EntityType,
		&i.EntityID,
		&i.PayloadJson,
	)
	return i, err
}

const getEventBySeq = `-- name: GetEventBySeq :one
SELECT campaign_id, seq, event_hash, timestamp, event_type, session_id, request_id, invocation_id, actor_type, actor_id, entity_type, entity_id, payload_json FROM events WHERE campaign_id = ? AND seq = ?
`

type GetEventBySeqParams struct {
	CampaignID string `json:"campaign_id"`
	Seq        int64  `json:"seq"`
}

func (q *Queries) GetEventBySeq(ctx context.Context, arg GetEventBySeqParams) (Event, error) {
	row := q.db.QueryRowContext(ctx, getEventBySeq, arg.CampaignID, arg.Seq)
	var i Event
	err := row.Scan(
		&i.CampaignID,
		&i.Seq,
		&i.EventHash,
		&i.Timestamp,
		&i.EventType,
		&i.SessionID,
		&i.RequestID,
		&i.InvocationID,
		&i.ActorType,
		&i.ActorID,
		&i.EntityType,
		&i.EntityID,
		&i.PayloadJson,
	)
	return i, err
}

const getEventSeq = `-- name: GetEventSeq :one
SELECT next_seq FROM event_seq WHERE campaign_id = ?
`

func (q *Queries) GetEventSeq(ctx context.Context, campaignID string) (int64, error) {
	row := q.db.QueryRowContext(ctx, getEventSeq, campaignID)
	var next_seq int64
	err := row.Scan(&next_seq)
	return next_seq, err
}

const getLatestEventSeq = `-- name: GetLatestEventSeq :one
SELECT CAST(COALESCE(MAX(seq), 0) AS INTEGER) as latest_seq FROM events WHERE campaign_id = ?
`

func (q *Queries) GetLatestEventSeq(ctx context.Context, campaignID string) (int64, error) {
	row := q.db.QueryRowContext(ctx, getLatestEventSeq, campaignID)
	var latest_seq int64
	err := row.Scan(&latest_seq)
	return latest_seq, err
}

const getLatestSnapshot = `-- name: GetLatestSnapshot :one
SELECT campaign_id, session_id, event_seq, character_states_json, gm_state_json, system_state_json, created_at FROM snapshots
WHERE campaign_id = ?
ORDER BY event_seq DESC
LIMIT 1
`

func (q *Queries) GetLatestSnapshot(ctx context.Context, campaignID string) (Snapshot, error) {
	row := q.db.QueryRowContext(ctx, getLatestSnapshot, campaignID)
	var i Snapshot
	err := row.Scan(
		&i.CampaignID,
		&i.SessionID,
		&i.EventSeq,
		&i.CharacterStatesJson,
		&i.GmStateJson,
		&i.SystemStateJson,
		&i.CreatedAt,
	)
	return i, err
}

const getSnapshot = `-- name: GetSnapshot :one
SELECT campaign_id, session_id, event_seq, character_states_json, gm_state_json, system_state_json, created_at FROM snapshots
WHERE campaign_id = ? AND session_id = ?
`

type GetSnapshotParams struct {
	CampaignID string `json:"campaign_id"`
	SessionID  string `json:"session_id"`
}

func (q *Queries) GetSnapshot(ctx context.Context, arg GetSnapshotParams) (Snapshot, error) {
	row := q.db.QueryRowContext(ctx, getSnapshot, arg.CampaignID, arg.SessionID)
	var i Snapshot
	err := row.Scan(
		&i.CampaignID,
		&i.SessionID,
		&i.EventSeq,
		&i.CharacterStatesJson,
		&i.GmStateJson,
		&i.SystemStateJson,
		&i.CreatedAt,
	)
	return i, err
}

const incrementEventSeq = `-- name: IncrementEventSeq :exec
INSERT INTO event_seq (campaign_id, next_seq)
VALUES (?, 2)
ON CONFLICT(campaign_id) DO UPDATE SET
    next_seq = event_seq.next_seq + 1
`

func (q *Queries) IncrementEventSeq(ctx context.Context, campaignID string) error {
	_, err := q.db.ExecContext(ctx, incrementEventSeq, campaignID)
	return err
}

const initEventSeq = `-- name: InitEventSeq :exec
INSERT OR IGNORE INTO event_seq (campaign_id, next_seq) VALUES (?, 1)
`

func (q *Queries) InitEventSeq(ctx context.Context, campaignID string) error {
	_, err := q.db.ExecContext(ctx, initEventSeq, campaignID)
	return err
}

const listEvents = `-- name: ListEvents :many
SELECT campaign_id, seq, event_hash, timestamp, event_type, session_id, request_id, invocation_id, actor_type, actor_id, entity_type, entity_id, payload_json FROM events
WHERE campaign_id = ? AND seq > ?
ORDER BY seq
LIMIT ?
`

type ListEventsParams struct {
	CampaignID string `json:"campaign_id"`
	Seq        int64  `json:"seq"`
	Limit      int64  `json:"limit"`
}

func (q *Queries) ListEvents(ctx context.Context, arg ListEventsParams) ([]Event, error) {
	rows, err := q.db.QueryContext(ctx, listEvents, arg.CampaignID, arg.Seq, arg.Limit)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	items := []Event{}
	for rows.Next() {
		var i Event
		if err := rows.Scan(
			&i.CampaignID,
			&i.Seq,
			&i.EventHash,
			&i.Timestamp,
			&i.EventType,
			&i.SessionID,
			&i.RequestID,
			&i.InvocationID,
			&i.ActorType,
			&i.ActorID,
			&i.EntityType,
			&i.EntityID,
			&i.PayloadJson,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Close(); err != nil {
		return nil, err
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const listEventsBySession = `-- name: ListEventsBySession :many
SELECT campaign_id, seq, event_hash, timestamp, event_type, session_id, request_id, invocation_id, actor_type, actor_id, entity_type, entity_id, payload_json FROM events
WHERE campaign_id = ? AND session_id = ? AND seq > ?
ORDER BY seq
LIMIT ?
`

type ListEventsBySessionParams struct {
	CampaignID string `json:"campaign_id"`
	SessionID  string `json:"session_id"`
	Seq        int64  `json:"seq"`
	Limit      int64  `json:"limit"`
}

func (q *Queries) ListEventsBySession(ctx context.Context, arg ListEventsBySessionParams) ([]Event, error) {
	rows, err := q.db.QueryContext(ctx, listEventsBySession,
		arg.CampaignID,
		arg.SessionID,
		arg.Seq,
		arg.Limit,
	)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	items := []Event{}
	for rows.Next() {
		var i Event
		if err := rows.Scan(
			&i.CampaignID,
			&i.Seq,
			&i.EventHash,
			&i.Timestamp,
			&i.EventType,
			&i.SessionID,
			&i.RequestID,
			&i.InvocationID,
			&i.ActorType,
			&i.ActorID,
			&i.EntityType,
			&i.EntityID,
			&i.PayloadJson,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Close(); err != nil {
		return nil, err
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const listSnapshots = `-- name: ListSnapshots :many
SELECT campaign_id, session_id, event_seq, character_states_json, gm_state_json, system_state_json, created_at FROM snapshots
WHERE campaign_id = ?
ORDER BY event_seq DESC
LIMIT ?
`

type ListSnapshotsParams struct {
	CampaignID string `json:"campaign_id"`
	Limit      int64  `json:"limit"`
}

func (q *Queries) ListSnapshots(ctx context.Context, arg ListSnapshotsParams) ([]Snapshot, error) {
	rows, err := q.db.QueryContext(ctx, listSnapshots, arg.CampaignID, arg.Limit)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	items := []Snapshot{}
	for rows.Next() {
		var i Snapshot
		if err := rows.Scan(
			&i.CampaignID,
			&i.SessionID,
			&i.EventSeq,
			&i.CharacterStatesJson,
			&i.GmStateJson,
			&i.SystemStateJson,
			&i.CreatedAt,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Close(); err != nil {
		return nil, err
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const markOutcomeApplied = `-- name: MarkOutcomeApplied :exec
INSERT INTO outcome_applied (campaign_id, session_id, request_id) VALUES (?, ?, ?)
`

type MarkOutcomeAppliedParams struct {
	CampaignID string `json:"campaign_id"`
	SessionID  string `json:"session_id"`
	RequestID  string `json:"request_id"`
}

func (q *Queries) MarkOutcomeApplied(ctx context.Context, arg MarkOutcomeAppliedParams) error {
	_, err := q.db.ExecContext(ctx, markOutcomeApplied, arg.CampaignID, arg.SessionID, arg.RequestID)
	return err
}

const putSnapshot = `-- name: PutSnapshot :exec

INSERT INTO snapshots (
    campaign_id, session_id, event_seq, character_states_json, gm_state_json, system_state_json, created_at
) VALUES (?, ?, ?, ?, ?, ?, ?)
ON CONFLICT(campaign_id, session_id) DO UPDATE SET
    event_seq = excluded.event_seq,
    character_states_json = excluded.character_states_json,
    gm_state_json = excluded.gm_state_json,
    system_state_json = excluded.system_state_json,
    created_at = excluded.created_at
`

type PutSnapshotParams struct {
	CampaignID          string `json:"campaign_id"`
	SessionID           string `json:"session_id"`
	EventSeq            int64  `json:"event_seq"`
	CharacterStatesJson []byte `json:"character_states_json"`
	GmStateJson         []byte `json:"gm_state_json"`
	SystemStateJson     []byte `json:"system_state_json"`
	CreatedAt           int64  `json:"created_at"`
}

// Snapshot Queries (unchanged from campaign_events.sql)
func (q *Queries) PutSnapshot(ctx context.Context, arg PutSnapshotParams) error {
	_, err := q.db.ExecContext(ctx, putSnapshot,
		arg.CampaignID,
		arg.SessionID,
		arg.EventSeq,
		arg.CharacterStatesJson,
		arg.GmStateJson,
		arg.SystemStateJson,
		arg.CreatedAt,
	)
	return err
}

const setCampaignForkMetadata = `-- name: SetCampaignForkMetadata :exec
UPDATE campaigns
SET parent_campaign_id = ?, fork_event_seq = ?, origin_campaign_id = ?
WHERE id = ?
`

type SetCampaignForkMetadataParams struct {
	ParentCampaignID sql.NullString `json:"parent_campaign_id"`
	ForkEventSeq     sql.NullInt64  `json:"fork_event_seq"`
	OriginCampaignID sql.NullString `json:"origin_campaign_id"`
	ID               string         `json:"id"`
}

func (q *Queries) SetCampaignForkMetadata(ctx context.Context, arg SetCampaignForkMetadataParams) error {
	_, err := q.db.ExecContext(ctx, setCampaignForkMetadata,
		arg.ParentCampaignID,
		arg.ForkEventSeq,
		arg.OriginCampaignID,
		arg.ID,
	)
	return err
}
